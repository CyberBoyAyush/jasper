<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Analyst Memo: {{ report.query | truncate(40) }}</title>
    <style>
{{ css_content | safe }}
    </style>
</head>
<body>
    
    <!-- ===== COVER PAGE ===== -->
    <section class="cover-page">
        <div class="cover-content">
            <div class="cover-logo">JASPER FINANCE</div>
            <h1 class="cover-title">Analyst Research Memo</h1>
            <p style="color: #bdc3c7; font-size: 14pt; margin-top: -40pt; margin-bottom: 60pt; font-weight: 300;">
                A deterministic analysis of the business model using validated financial data.
            </p>
            
            <div class="cover-query">
                "{{ report.query }}"
            </div>
            
            <div class="metadata-grid" style="color: #bdc3c7; background: transparent; border: none; border-top: 1px solid #7f8c8d;">
                <table style="width: 100%; border: none; background: transparent;">
                    <tr class="metadata-row">
                        <td class="metadata-label" style="color: #ecf0f1; border: none; background: transparent;">Release Date</td>
                        <td style="text-align: right; border: none; background: transparent;">{{ report.timestamp.strftime('%B %d, %Y') }}</td>
                    </tr>
                    <tr class="metadata-row">
                        <td class="metadata-label" style="color: #ecf0f1; border: none; background: transparent;">Reference Entities</td>
                        <td style="text-align: right; border: none; background: transparent;">{{ report.tickers | join(', ') or 'N/A' }}</td>
                    </tr>
                    <tr class="metadata-row">
                        <td class="metadata-label" style="color: #ecf0f1; border: none; background: transparent;">Reliability Score</td>
                        <td style="text-align: right; border: none; background: transparent;" class="{% if report.confidence_score > 0.8 %}text-success{% else %}text-danger{% endif %}">
                            {{ (report.confidence_score * 100) | round(1) }}%
                        </td>
                    </tr>
                </table>
            </div>
        </div>
        
        <div class="cover-footer">
            Jasper Intelligence Engine v{{ report.version }} | Deterministic Financial Research
        </div>
    </section>

    <!-- ===== MAIN REPORT CONTENT ===== -->
    <div class="report-container" style="padding: 0 1.5cm;">
        
        <!-- ===== EXECUTIVE CONFIDENCE BLOCK (New early placement) ===== -->
        <section class="report-section" style="margin-top: 30pt;">
            <div class="callout callout-confidence" style="border: 1pt solid #2980b9; margin: 0;">
                <table style="width: 100%; border: none; margin: 0;">
                    <tr>
                        <td style="border: none; padding: 0;"><strong>RESEARCH CONFIDENCE:</strong></td>
                        {% if report.confidence_breakdown %}
                        <td style="border: none; padding: 0; text-align: right;">
                            <span style="margin-left: 10pt;">Coverage: {{ (report.confidence_breakdown.data_coverage * 100) | round(0) }}%</span>
                            <span style="margin-left: 10pt;">Quality: {{ (report.confidence_breakdown.data_quality * 100) | round(0) }}%</span>
                            <span style="margin-left: 10pt;">Inference: {{ (report.confidence_breakdown.inference_strength * 100) | round(0) }}%</span>
                        </td>
                        {% endif %}
                    </tr>
                </table>
            </div>
        </section>

        <!-- Semantic Section Wrap for the entire synthesized narrative -->
        <article class="narrative">
            {{ synthesis_html | safe }}
        </article>

        <!-- ===== VALIDATION & DETAILS (Moved down) ===== -->
        {% if not report.is_valid or report.validation_issues %}
        <section class="report-section" id="limitations">
            <div class="warning-block">
                <h3>âš  Critical Validation Notes</h3>
                <ul>
                    {% for issue in report.validation_issues %}
                    <li>{{ issue }}</li>
                    {% endfor %}
                </ul>
            </div>
        </section>
        {% endif %}

        <!-- ===== APPENDIX ===== -->
        <section class="report-section appendix">
            <h2>APPENDIX</h2>
            
            <h3>Data Sourcing & Methodology</h3>
            <p>
                The following data providers were queried to compile this report. Analysis is performed 
                using deterministic logic gates to ensure auditability.
            </p>
            <ul>
                {% for source in report.data_sources %}
                <li>{{ source }}</li>
                {% endfor %}
            </ul>

            <h3>System Metadata</h3>
            <div class="metadata-grid">
                <table style="width: 100%; border: none;">
                    <tr class="metadata-row">
                        <td class="metadata-label" style="border: none;">Report ID</td>
                        <td style="text-align: right; border: none;"><span class="footer-hash">{{ report.query | hash }}</span></td>
                    </tr>
                    <tr class="metadata-row">
                        <td class="metadata-label" style="border: none;">Engine Version</td>
                        <td style="text-align: right; border: none;">v{{ report.version }}</td>
                    </tr>
                    <tr class="metadata-row">
                        <td class="metadata-label" style="border: none;">Task Audit Trail</td>
                        <td style="text-align: right; border: none;">{{ report.task_count }} successful execution steps</td>
                    </tr>
                    <tr class="metadata-row">
                        <td class="metadata-label" style="border: none;">Generation Time</td>
                        <td style="text-align: right; border: none;">{{ report.timestamp.isoformat() }}</td>
                    </tr>
                </table>
            </div>

            <div class="disclaimer">
                <strong>DETERMINISTIC DISCLAIMER:</strong> This report is generated by a deterministic agent. 
                All findings are derived strictly from identified tools and cross-referenced data. 
                This does not constitute professional investment advice.
            </div>
        </section>
    </div>

</body>
</html>
</html>
